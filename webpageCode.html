<!DOCTYPE html>
<html>

<head>
    <style>
        .btn {
            display: inline-block;
            margin: 10px;
            text-decoration: none;
            background: #ACECA1;
            color: #629460;
            font: 40px calibri;
            border-radius: 32px;
            box-shadow: 0px 0px 2px 2px #243119;
            border: solid 5px #96BE8C;
            cursor: pointer;
            text-align: center;
            padding: 10px;
        }

        body {
            font-family: "Calibri";
            background-color: #C9F2C7;
            text-align: center;
        }

        h1 {
            color: #629460;
            text-align: center;
            font-size: 60px;
        }

        #word,
        #sentence,
        #constructedSentence {
            font-size: 40px;
            margin: 20px;
        }

        .options {
            margin-top: 20px;
        }

        .selected {
            outline: 5px solid #4c0603;
            /* Estilo para item selecionado */
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

<script>
    var mqtt;
    var reconnectTimeout = 30000;
    var host = "test.mosquitto.org";
    var port = 8080;

    function publishMessage(message) {
        if (!mqtt || mqtt.connected === false) {
            console.log(message);
            return;
        }
        const mensagem = message;
        mqtt.send("poliQuestPortasESP", mensagem, 1, false);
    }

    function onConnect() {
        console.log("Conectado");
        mqtt.subscribe("poliQuestPortasESP");
    }

    function onError(message) {
        console.log("Falha: " + message.errorCode + " " + message.errorMessage);
        setTimeout(MQTTConnect, reconnectTimeout);
    }

    function onMessageArrived(msg) {
        console.log(msg.payloadString);

        if (msg.payloadString == "{00000000000010}") {
            currentIndex++;
            updateSelected(currentIndex);
        }

        if (msg.payloadString == "{00000000000100}") {
            if (currentIndex == 0) {
                updateSelected(currentIndex);
            } else {
                currentIndex--;
                updateSelected(currentIndex);
            }
        }

        if (msg.payloadString == "{00000000000001}") {
            menuItems[currentIndex].click();
        }
    }

    function MQTTConnect() {
        console.log("Contectando " + host + " " + port);
        mqtt = new Paho.MQTT.Client(host, port, "poliQuestPortasESP");
        var options = {
            timeout: 30000,
            keepAliveInterval: 30000,
            onSuccess: onConnect,
            onFailure: onError
        };
        mqtt.onMessageArrived = onMessageArrived;
        mqtt.onConnectionLost = onError;
        mqtt.connect(options);
    }

    function playSound(sound) {
        var sound = document.getElementById(sound);
        sound.play();
    }

</script>


<audio id="acertou">
    <source src="positivo.mp3" type="audio/mpeg">
</audio>

<audio id="errou">
    <source src="perdeu_jogo.mp3" type="audio/mpeg">
</audio>

<audio id="click">
    <source src="click.mp3" type="audio/mpeg">
</audio>

<!-- Áudios para as palavras em outro idioma -->
<audio id="soundHouse">
    <source src="house.mp3" type="audio/mpeg">
</audio>

<audio id="soundDog">
    <source src="dog.mp3" type="audio/mpeg">
</audio>

<audio id="soundTree">
    <source src="tree.mp3" type="audio/mpeg">
</audio>

<audio id="soundThecatisunderthetable">
    <source src="thecatisunderthetable.mp3" type="audio/mpeg">
</audio>

<audio id="soundThedogisinthehouse">
    <source src="thedogisinthehouse.mp3" type="audio/mpeg">
</audio>

</head>

<body onLoad="MQTTConnect()">
    <h1 id="mainTitle">Bem-vindo! <br> PoliQuest</h1>
    <div id="mainMenu">
        <a href="#" class="btn" onclick="showMode(1)">Modo 1</a>
        <a href="#" class="btn" onclick="showMode(2)">Modo 2</a>
    </div>
    <div id="mode1" class="hidden">
        <p id="word"></p>
        <hr>
        <div class="options" id="optionsMode1"></div>
        <button id="playSoundButton" class="btn" onclick="playWordSound()">Ouvir Palavra</button>
        <a href="#" class="btn" onclick='backToMenu()'>Voltar</a>
    </div>
    <div id="mode2" class="hidden">
        <p id="sentence"></p>
        <p id="constructedSentence"></p>
        <hr>
        <div class="options" id="optionsMode2"></div>
        <!-- Botão para ouvir a frase completa -->
        <button id="playSentenceButton" class="btn" onclick="playSentenceSound()">Ouvir Frase</button>
        <a href="#" class="btn" onclick='clearConstructedSentence()'>Limpar Frase</a><br>
        <a href="#" class="btn" onclick='checkSentence()'>Verificar Frase</a><br>
        <a href="#" class="btn" onclick='backToMenu()'>Voltar</a>
    </div>
    <script>
        let currentQuestionIndex = 0;
        let currentSentenceIndex = 0;
        let constructedSentence = [];
        let currentIndex = 0;
        let menuItems = document.querySelectorAll('#mainMenu .btn');
        let modeActive = false;

        function updateSelected(index) {
            menuItems.forEach(item => item.classList.remove('selected'));
            if (menuItems.length > 0) {
                menuItems[index].classList.add('selected');
            }
        }

        function backToMenu() {
            modeActive = false;
            currentQuestionIndex = 0;
            currentSentenceIndex = 0;
            constructedSentence = [];
            document.getElementById('mainTitle').style.display = 'block';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('mode1').classList.add('hidden');
            document.getElementById('mode2').classList.add('hidden');
            menuItems = document.querySelectorAll('#mainMenu .btn');
            currentIndex = 0;
            updateSelected(currentIndex);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                alert("Você completou todas as perguntas do Modo 1!");
                backToMenu();
                return;
            }

            let question = questions[currentQuestionIndex];
            document.getElementById('word').textContent = `Palavra: ${question.word}`;
            let optionsHtml = '';
            question.options.forEach((option, index) => {
                optionsHtml += `<a href="#" class="btn" onclick='checkAnswer("${index}", "${option}", "${question.correct}")'>${option}</a>`;
            });
            document.getElementById('optionsMode1').innerHTML = optionsHtml;
            menuItems = document.querySelectorAll('#mode1 .btn, #mode1 .options a');
            currentIndex = 0;
            updateSelected(currentIndex);
            // Atualiza o atributo onclick do botão para reproduzir o som correto
            document.getElementById('playSoundButton').setAttribute('onclick', `playWordSound('${question.correct}')`);
        }

        function playWordSound(sound) {
            var soundElement = document.getElementById('sound' + sound);
            if (soundElement) {
                soundElement.play();
            } else {
                console.log("Som não encontrado para a palavra: " + sound);
            }
        }

        function checkAnswer(index, given, correct) {
            if (given === correct) {
                publishMessage(index);
                playSound("acertou");
                alert("Correto!");
                currentQuestionIndex++;
                loadQuestion();
            } else {
                publishMessage(index);
                playSound("errou");
                alert("Incorreto!");
            }
        }

        function playSentenceSound() {
            let sentence = sentences[currentSentenceIndex];
            let soundElement = document.getElementById('sound' + sentence.english.replace(/ /g, ''));
            if (soundElement) {
                soundElement.play();
            } else {
                console.log("Som não encontrado para a frase: " + sentence.english);
            }
        }

        function loadSentence() {
            if (currentSentenceIndex >= sentences.length) {
                alert("Você completou todas as frases do Modo 2!");
                backToMenu();
                return;
            }

            let sentence = sentences[currentSentenceIndex];
            document.getElementById('sentence').textContent = `Frase: ${sentence.english}`;
            document.getElementById('playSentenceButton').setAttribute('onclick', `playSentenceSound()`);

            // Limpar a frase construída e atualizar a exibição
            constructedSentence = [];
            document.getElementById('constructedSentence').textContent = '';

            let optionsHtml = '';
            sentence.portuguese.forEach((word, index) => {
                optionsHtml += `<a href="#" class="btn" onclick='addToSentence("${index}", "${word}")'>${word}</a>`;
            });
            document.getElementById('optionsMode2').innerHTML = optionsHtml;
            menuItems = document.querySelectorAll('#mode2 .btn, #mode2 .options a');
            currentIndex = 0;
            updateSelected(currentIndex);
        }

        function addToSentence(index, word) {
            publishMessage(index);
            playSound("click");
            constructedSentence.push(word);
            document.getElementById('constructedSentence').textContent = constructedSentence.join(' ');
        }


        function clearConstructedSentence() {
            publishMessage('9');
            constructedSentence = [];
            document.getElementById('constructedSentence').textContent = '';
        }


        function checkSentence() {
            let sentence = sentences[currentSentenceIndex];
            if (constructedSentence.join(' ') === sentence.correct) {
                alert("Correto!");
                playSound("acertou");
                currentSentenceIndex++;
                if (currentSentenceIndex < sentences.length) {
                    loadSentence();
                } else {
                    alert("Você completou todas as frases do Modo 2!");
                    backToMenu();
                }
            } else {
                alert("Incorreto! Tente novamente.");
                playSound("errou");
            }
        }

        function showMode(mode) {
            modeActive = true;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('mainTitle').style.display = 'none';

            if (mode === 1) {
                document.getElementById('mode1').classList.remove('hidden');
                document.getElementById('mode2').classList.add('hidden');
                loadQuestion();
            } else if (mode === 2) {
                document.getElementById('mode2').classList.remove('hidden');
                document.getElementById('mode1').classList.add('hidden');
                loadSentence();
            }
        }

        document.addEventListener('keydown', function (event) {
            if (modeActive) {
                if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    currentIndex = (event.key === 'ArrowLeft') ?
                        (currentIndex > 0 ? currentIndex - 1 : menuItems.length - 1) :
                        (currentIndex < menuItems.length - 1 ? currentIndex + 1 : 0);
                    updateSelected(currentIndex);
                } else if (event.key === 'Enter' && menuItems[currentIndex]) {
                    menuItems[currentIndex].click();
                }
            } else {
                if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    currentIndex = (event.key === 'ArrowLeft') ?
                        (currentIndex > 0 ? currentIndex - 1 : menuItems.length - 1) :
                        (currentIndex < menuItems.length - 1 ? currentIndex + 1 : 0);
                    updateSelected(currentIndex);
                } else if (event.key === 'Enter') {
                    // Ajuste aqui: garantir que a função showMode seja chamada com o índice correto.
                    showMode(currentIndex + 1);
                }
            }
        });

        updateSelected(0);


        const questions = [
            { word: "Casa", options: ["House", "Cat", "Dog"], correct: "House" },
            { word: "Cão", options: ["Dog", "House", "Tree"], correct: "Dog" },
            { word: "Árvore", options: ["Cat", "Tree", "House"], correct: "Tree" }
        ];

        const sentences = [
            { english: "The cat is under the table", portuguese: ["debaixo", "está", "gato", "O", "da", "mesa"], correct: "O gato está debaixo da mesa" },
            { english: "The dog is in the house", portuguese: ["está", "O", "na", "cachorro", "casa"], correct: "O cachorro está na casa" }
        ];
    </script>


</body>

</html>